<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/jspsych@8.2.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@2.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-initialize-microphone@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css">
  <style>
    body.recording-bg {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .recording-bg {
      background-color: #ffdce2 !important;
      transition: background-color 0.5s ease;
    }
    #captcha-container {
      display: none; /* Hidden by default */
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      z-index: 9999;
      text-align: center;
  }
  </style>
</head>
<body>
  <div id="captcha-container">
  <h3>Security Verification</h3>
  <p>Please confirm you are human to begin.</p>
  <div id="g-recaptcha-target"></div>
  <br>
  <button id="captcha-proceed" style="display:none; padding: 10px 20px;">Begin Study</button>
</div>
</body>
<script>    

  const jsPsych = initJsPsych({
    show_progress_bar: true,
    auto_update_progress_bar: true,
    on_finish: function() {
      jsPsych.data.displayData();
      }
    });

  const prolific_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
  const study_id = jsPsych.data.getURLVariable('STUDY_ID');
  const session_id = jsPsych.data.getURLVariable('SESSION_ID');

  jsPsych.data.addProperties({
    prolific_id: prolific_id,
    study_id: study_id,
    session_id: session_id
  });

  const filename = prolific_id ? `${prolific_id}.csv` : `${jsPsych.randomization.randomID(10)}.csv`;

  const captcha_resolved = false;

  const captcha_trial = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: '', // Blank screen while the overlay is visible
    choices: "NO_KEYS",
    on_load: function() {
      const container = document.getElementById('captcha-container');
      const btn = document.getElementById('captcha-proceed');
      container.style.display = 'block';

      window.correctCaptcha = function(response) {
        window.captchaToken = response;
        btn.style.display = 'inline-block';
      };

      // Only render if it hasn't been rendered yet
      if (document.getElementById('g-recaptcha-target').innerHTML === "") {
        grecaptcha.render('g-recaptcha-target', {
          'sitekey': '6Le_Yk0sAAAAAEK5jvozPPEva_4_9OfSsvEEmq4u',
          'callback': 'correctCaptcha'
        });
      }

      btn.onclick = () => {
        container.style.display = 'none';
        jsPsych.finishTrial({ captcha_token: window.captchaToken });
    };
  }
};

  const welcome = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `Welcome to the study!`,
    choices: ['Continue']
  };

  const instructions_basic = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
    <p>In this study, you'll make a series of short text responses about yourself.
    <br>There are no right or wrong answers, we’re just curious what people say about themselves!</p>
    `,
    choices: ['Continue']
  };

  const instructions_coffee = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
    <p>Imagine you've just met someone new in a friendly, casual setting<br>(<i>like waiting in line for coffee or at a casual get-together</i>)<br>and you’ve just exchanged names.</p> 
    <p> <b>What are some other things you’d like to say about yourself?</b></p>
    `,
    choices: ['Begin Task']
  };

  var text_trials = {
    timeline: [
        {
            type: jsPsychSurveyText,
            questions: () => [
                {
                    prompt: jsPsych.timelineVariable('instruction'),
                    rows: 5,
                    columns: 50,
                    required: true
                }
            ],
            on_finish: function(data) {
                data.absolute_time_ms = performance.now();
                data.rt_ms = data.rt;
            }
        }
    ],
    timeline_variables: [
        {instruction: "What's the first thing you'd like to say about yourself?<span style='color:gray;'> (1 out of 12)</span>"},
        {instruction: "What's another thing you'd like to say about yourself?<span style='color:gray;'> (2 out of 12)</span>"},
        {instruction: "What else would you like to say about yourself?<span style='color:gray;'> (3 out of 12)</span>"},
        {instruction: "What's another thing you'd like to share about yourself?<span style='color:gray;'> (4 out of 12)</span>"},
        {instruction: "What else would you like to share about yourself?<span style='color:gray;'> (5 out of 12)</span>"},
        {instruction: "What's another thing you'd like to say about yourself?<span style='color:gray;'> (6 out of 12)</span>"},
        {instruction: "What else would you like to say about yourself?<span style='color:gray;'> (7 out of 12)</span>"},
        {instruction: "What's another thing you'd like to share about yourself?<span style='color:gray;'> (8 out of 12)</span>"},
        {instruction: "What else would you like to share about yourself?<span style='color:gray;'> (9 out of 12)</span>"},
        {instruction: "What's another thing you'd like to say about yourself?<span style='color:gray;'> (10 out of 12)</span>"},
        {instruction: "What else would you like to say about yourself?<span style='color:gray;'> (11 out of 12)</span>"},
        {instruction: "What's the last thing you'd like to share about yourself?<span style='color:gray;'> (12 out of 12)</span>"}
    ]
  };

  const instructions_fluency_1 = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
    <p>Thank you for sharing about yourself!
    <br>Before we let you go, we have a quick word game for you to complete.</p>
    `,
    choices: ['Continue']
  };

  const instructions_fluency_2 = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
    <p>In this new task, we'll give you a category and ask you to 
    <br>name the first 12 members of that category you can think of. 
    `,
    choices: ['Continue']
  };

    const instructions_fluency_3 = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
    <p>Please provide one answer at a time. 
    <br>For example, if the category is 'fruit', then you might type 'apple', press Enter to submit, 
    <br>and then proceed to type 'banana', and so on.
    `,
    choices: ['Begin Task']
  };

  let response_data = [];
  let trialStartTime;

  const animal_fluency = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div style="margin-bottom: 20px;">
        <h2 style="margin-bottom: 5px;">The category: <b>Animals</b></h2>
        <p id="instruction-text" style="color: #555; margin-top: 0;">Remember: Type one animal, press Enter, then type the next</p>
        <p id="counter-text" style="font-weight: bold; color: #333;">0/12 animals</p>
      </div>
      <div id="chip-container" style="border:1px solid #ccc; padding:10px; min-height:50px; width: 500px; margin: 0 auto 10px auto; border-radius: 5px; text-align: left; display: flex; flex-wrap: wrap; align-items: center;">
        <span id="placeholder-text" style="color: gray; font-style: italic; font-family: sans-serif; margin-left: 5px;">Your responses will appear here...</span>
      </div>
      <input type="text" id="animal-input" 
              placeholder="Type an animal and press Enter..." 
              autocomplete="off"
              style="width: 500px; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px;">
    `,
    choices: "NO_KEYS", 
    on_load: function() {
    trialStartTime = performance.now();
    response_data = [];
      const input = document.getElementById('animal-input');
      const container = document.getElementById('chip-container');
      const placeholder = document.getElementById('placeholder-text');
      const counterElement = document.getElementById('counter-text');

      input.focus();

      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && input.value.trim() !== "") {
          if (placeholder) {
            placeholder.remove();
          }
          
          const word = input.value.trim();
          const relativeTimestamp = performance.now() - trialStartTime;
          const timestamp = performance.now(); 
          
          response_data.push({ word: word, time: timestamp, rt_ms: relativeTimestamp });

          counterElement.innerText = `${response_data.length}/12 animals`;

          const chip = document.createElement('span');
          chip.innerText = word;
          chip.style = "background:#eee; padding:5px; margin:5px; border-radius:15px; display:inline-block;";
          container.appendChild(chip);

          input.value = "";

          if (response_data.length >= 12) {
            jsPsych.finishTrial();
          }
        }
      });
    },
    on_finish: function(data) {
      data.response = JSON.stringify(response_data);
      console.log("Animal Data Saved:", data.response);
    }
  };

  const saving_trial = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
    <div style="font-size: 20px;">
      <p>Please wait while we save your responses...
      <br>You will be redirected back to Prolific shortly.</p>
      <div class="loader"></div> </div>
    `,
    choices: "NO_KEYS",
    trial_duration: 2000, // 2 seconds
  };

  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "fs53x4EAl0QS",
    filename: filename, 
    data_string: () => jsPsych.data.get().csv()
  };

  const goodbye = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "Thank you for participating! Click the button below to return to Prolific and complete your submission.",
    choices: ["Return to Prolific"],
    on_finish: function() {
      window.location.href = "https://app.prolific.com/submissions/complete?cc=CHTCOA66";
  }
};


  jsPsych.run([captcha_trial, welcome, instructions_basic, instructions_coffee, text_trials, instructions_fluency_1, instructions_fluency_2, instructions_fluency_3, animal_fluency, saving_trial, save_data, goodbye]);

</script>

</html>
