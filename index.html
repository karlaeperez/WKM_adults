<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/jspsych@8.2.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@2.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-initialize-microphone@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css">
  <style>
    body.recording-bg {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .recording-bg {
      background-color: #fff8f9 !important;
      transition: background-color 0.5s ease;
    }

  </style>
</head>
<body></body>
<script>    

  const jsPsych = initJsPsych({
    show_progress_bar: true,
    auto_update_progress_bar: true,
    on_finish: function() {
      jsPsych.data.displayData();
      }
    });

  const subject_id = jsPsych.randomization.randomID(10);
  const filename = `${subject_id}.csv`;
  jsPsych.data.addProperties({
    subject: subject_id
  });

  const welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
    Welcome to the study!
    <br><p><span style="color:gray;">Press any key to proceed.</span></p>
    `
  };

  const instructions_general = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
    <p>Imagine you've just met someone new in a friendly, casual setting<br>(<i>like waiting in line for coffee or at a casual get-together</i>)<br>and you’ve just exchanged names.</p> 
    <p> What are some other things you’d like to say about yourself?</p>
    <p><span style="color:gray;">Press any key to proceed.</span></p>
    `
  };

  const instructions_audio = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
    <p>In this task you will be asked to describe <b>12 things about you</b>, one at a time.
    <br>You will have up to <b>3 minutes</b> to audio record your answer for each item.</p>
    <p>There are no right or wrong answers, we’re just curious what people say about themselves!</p>
    <p><span style="color:gray;">Press any key to begin.</span></p>
    `
  };

  const init_mic = {
    type: jsPsychInitializeMicrophone
  }

  var audio_trials = {
    timeline: [
        {
            type: jsPsychHtmlButtonResponse,
            stimulus: jsPsych.timelineVariable('instruction'),
            choices: ["Begin Recording"]
        },
        {
            type: jsPsychHtmlAudioResponse,
            stimulus: jsPsych.timelineVariable('stimulus_test'),
            recording_duration: 180000,
            show_done_button: true,
            done_button_label: "Finish Recording",
            on_load: function() {
              document.body.classList.add('recording-bg');
            },
            on_finish: function(data) {
              document.body.classList.remove('recording-bg');

              const audio_filename = `${subject_id}_trial_${jsPsych.getProgress().current_trial_global}.webm`;
              jsPsychPipe.saveBase64Data("fs53x4EAl0QS", audio_filename, data.response);
              data.response = audio_filename;
            }
        }
    ],
    timeline_variables: [
        {instruction: 'What would you like to say about you?<span style="color:gray;"> (1 out of 12)</span>', stimulus_test: 'What would you like to say about you?<span style="color:gray;"> (1 out of 12)</span><br><span style="color:red;"> Recording in progress...</span>'},
        {instruction: 'What would you like to say about you?<span style="color:gray;"> (2 out of 12)</span>', stimulus_test: 'What would you like to say about you?<span style="color:gray;"> (2 out of 12)</span><br><span style="color:red;"> Recording in progress...</span>'},
        {instruction: 'What would you like to say about you?<span style="color:gray;"> (3 out of 12)</span>', stimulus_test: 'What would you like to say about you?<span style="color:gray;"> (3 out of 12)</span><br><span style="color:red;"> Recording in progress...</span>'}
    ]
  }
  
  const goodbye = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "Thank you for participating!",
    choices: ["Finish"]
  };
  
  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "fs53x4EAl0QS",
    filename: filename,
    data_string: () => jsPsych.data.get().csv()
  };

  jsPsych.run([welcome, instructions_general, instructions_audio,init_mic, audio_trials, goodbye, save_data]);

</script>

</html>
