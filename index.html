<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/jspsych@8.2.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@2.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-initialize-microphone@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css">
  <style>
    body.recording-bg {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .recording-bg {
      background-color: #ffdce2 !important;
      transition: background-color 0.5s ease;
    }

  </style>
</head>
<body></body>
<script>    

  const jsPsych = initJsPsych({
    show_progress_bar: true,
    auto_update_progress_bar: true,
    on_finish: function() {
      jsPsych.data.displayData();
      }
    });

  const subject_id = jsPsych.randomization.randomID(10);
  const filename = `${subject_id}.csv`;
  jsPsych.data.addProperties({
    subject: subject_id
  });

  const captcha_resolved = false;

  const captcha_trial = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <div style="padding: 20px;">
            <h3>Security Verification</h3>
            <p>Please confirm you are human to begin the study.</p>
            <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                <div id="g-recaptcha-target"></div>
            </div>
        </div>`,
    choices: ["Begin Study"],
    on_load: function() {
        const btn = document.querySelector('#jspsych-html-button-response-button-0');
        if (btn) btn.style.display = 'none';

        function renderCaptcha() {
            if (typeof grecaptcha !== 'undefined' && typeof grecaptcha.render === 'function') {
                grecaptcha.render('g-recaptcha-target', {
                    'sitekey': '6Le_Yk0sAAAAAEK5jvozPPEva_4_9OfSsvEEmq4u', 
                    'callback': function() {
                        if (btn) btn.style.display = 'inline-block';
                    }
                });
            } else {
                setTimeout(renderCaptcha, 500);
            }
        }
        renderCaptcha();
    }
};

  const welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
    Welcome to the study!
    <br><p><span style="color:gray;">Press any key to proceed.</span></p>
    `
  };

  const instructions_basic = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
    <p>In this study, you'll make a series of short text responses about yourself.
    <br>There are no right or wrong answers, we’re just curious what people say about themselves!</p>
    <p><span style="color:gray;">Press any key to proceed.</span></p>
    `
  };

  const instructions_coffee = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
    <p>Imagine you've just met someone new in a friendly, casual setting<br>(<i>like waiting in line for coffee or at a casual get-together</i>)<br>and you’ve just exchanged names.</p> 
    <p> <b>What are some other things you’d like to say about yourself?</b></p>
    <p><span style="color:gray;">Press any key to proceed.</span></p>
    `
  };

  var text_trials = {
    timeline: [
        {
            type: jsPsychSurveyText,
            questions: () => [
                {
                    prompt: jsPsych.timelineVariable('instruction'),
                    rows: 5,
                    columns: 50,
                    required: true
                }
            ]
        }
    ],
    timeline_variables: [
        {instruction: "What's the first thing you'd like to say about yourself?<span style='color:gray;'> (1 out of 12)</span>"},
        {instruction: "What's another thing you'd like to say about yourself?<span style='color:gray;'> (2 out of 12)</span>"},
        {instruction: "What else would you like to say about yourself?<span style='color:gray;'> (3 out of 12)</span>"},
        {instruction: "What's another thing you'd like to share about yourself?<span style='color:gray;'> (4 out of 12)</span>"},
        {instruction: "What else would you like to share about yourself?<span style='color:gray;'> (5 out of 12)</span>"},
        {instruction: "What's another thing you'd like to say about yourself?<span style='color:gray;'> (6 out of 12)</span>"},
        {instruction: "What else would you like to say about yourself?<span style='color:gray;'> (7 out of 12)</span>"},
        {instruction: "What's another thing you'd like to share about yourself?<span style='color:gray;'> (8 out of 12)</span>"},
        {instruction: "What else would you like to share about yourself?<span style='color:gray;'> (9 out of 12)</span>"},
        {instruction: "What's another thing you'd like to say about yourself?<span style='color:gray;'> (10 out of 12)</span>"},
        {instruction: "What else would you like to say about yourself?<span style='color:gray;'> (11 out of 12)</span>"},
        {instruction: "What's the last thing you'd like to share about yourself?<span style='color:gray;'> (12 out of 12)</span>"}
    ]
  };

  const instructions_fluency = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
    <p>Thank you for sharing about yourself!</p>
    <p>Before we finish, I have one more task for you to complete.
    <br>I am going to give you a category, and I want you to type <b>as many things as you can</b> that belong to that category. 
    <br>For example, if I said "fruits", you might respond with "apple", "banana", "grape", etc.</p>
    <p>But please provide only one answer at a time!
    <br>e.g., after you type "apple", press <b>Enter</b> to submit before you type "banana".</p>
    <p><span style="color:gray;">Press any key to begin.</span></p>
    `
  };

  const category_animals = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
    <p>The category is: <b>Animals</b>
    <br>You will have <b>60 seconds</b> to type as many animals as you can think of.</p>
    <p><span style="color:gray;">Press any key to begin.</span></p>
    `
  };

  let response_data = [];
  let timerInterval;

  const animal_fluency = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div style="margin-bottom: 20px;">
        <h2 style="margin-bottom: 5px;">The category: <b>Animals</b></h2>
        <p id="timer-text" style="color: #d9534f; font-weight: bold; margin-top: 0;">Time remaining: 60s</p>
      </div>
      <div id="chip-container" style="border:1px solid #ccc; padding:10px; min-height:50px; width: 500px; margin: 0 auto 10px auto; border-radius: 5px; text-align: left; display: flex; flex-wrap: wrap; align-items: center;">
        <span id="placeholder-text" style="color: gray; font-style: italic; font-family: sans-serif; margin-left: 5px;">Your responses will appear here...</span>
      </div>
      <input type="text" id="animal-input" 
              placeholder="Type an animal and press Enter..." 
              autocomplete="off"
              style="width: 500px; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px;">
    `,
    choices: "NO_KEYS", 
    trial_duration: 60000, // 60 seconds for the task
    on_load: function() {
    response_data = [];
      const input = document.getElementById('animal-input');
      const container = document.getElementById('chip-container');
      const placeholder = document.getElementById('placeholder-text');
      const timerElement = document.getElementById('timer-text');
      let timeLeft = 60;

      input.focus();

      timerInterval = setInterval(() => {
        timeLeft--;
        if (timerElement) {
          timerElement.innerText = `Time remaining: ${timeLeft}s`;
        }
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
        }
      }, 1000);

      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && input.value.trim() !== "") {
          if (placeholder) {
            placeholder.remove();
          }
          
          const word = input.value.trim();
          const timestamp = performance.now(); 
          
          response_data.push({ word: word, time: timestamp });

          const chip = document.createElement('span');
          chip.innerText = word;
          chip.style = "background:#eee; padding:5px; margin:5px; border-radius:15px; display:inline-block;";
          container.appendChild(chip);

          input.value = "";
        }
      });
    },
    on_finish: function(data) {
      clearInterval(timerInterval);
      data.response = JSON.stringify(response_data);
      console.log("Animal Data Saved:", data.response);
    }
  };

  const goodbye = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "Thank you for participating!",
    choices: ["Finish"]
  };
  
  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "fs53x4EAl0QS",
    filename: filename, 
    data_string: () => jsPsych.data.get().csv()
  };

  jsPsych.run([captcha_trial, welcome, instructions_basic, instructions_coffee, text_trials, instructions_fluency, category_animals, animal_fluency, goodbye, save_data]);

</script>

</html>
